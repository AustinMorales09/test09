{
  "id": "589fc831f9fc0f352b528e77",
  "title": "Authentication with Socket.IO",
  "challengeType": 2,
  "forumTopicId": 301548,
  "dashedName": "authentication-with-socket-io",
  "solutions": [],
  "assignments": [],
  "tests": [
    {
      "text": "<p><code>passport.socketio</code> should be a dependency.</p>",
      "testString": "async (getUserInput) => {\n  const url = new URL(\"/_api/package.json\", getUserInput(\"url\"));\n  const res = await fetch(url);\n  const packJson = await res.json();\n  assert.property(\n    packJson.dependencies,\n    'passport.socketio',\n    'Your project should list \"passport.socketio\" as a dependency'\n  );\n}"
    },
    {
      "text": "<p><code>cookie-parser</code> should be a dependency.</p>",
      "testString": "async (getUserInput) => {\n  const url = new URL(\"/_api/package.json\", getUserInput(\"url\"));\n  const res = await fetch(url);\n  const packJson = await res.json();\n  assert.property(\n    packJson.dependencies,\n    'cookie-parser',\n    'Your project should list \"cookie-parser\" as a dependency'\n  );\n}"
    },
    {
      "text": "<p>passportSocketIo should be properly required.</p>",
      "testString": "async (getUserInput) => {\n  const url = new URL(\"/_api/server.js\", getUserInput(\"url\"));\n  const res = await fetch(url);\n  const data = await res.text();\n  assert.match(\n    data,\n    /require\\((['\"])passport\\.socketio\\1\\)/gi,\n    'You should correctly require and instantiate \"passport.socketio\"'\n  );\n}"
    },
    {
      "text": "<p>passportSocketIo should be properly setup.</p>",
      "testString": "async (getUserInput) => {\n  const url = new URL(\"/_api/server.js\", getUserInput(\"url\"));\n  const res = await fetch(url);\n  const data = await res.text();\n  assert.match(\n    data,\n    /io\\.use\\(\\s*\\w+\\.authorize\\(/,\n    'You should register \"passport.socketio\" as socket.io middleware and provide it correct options'\n  );\n}"
    }
  ],
  "description": "<section id=\"description\">\n<p>Currently, you cannot determine who is connected to your web socket. While <code>req.user</code> contains the user object, that's only when your user interacts with the web server, and with web sockets you have no <code>req</code> (request) and therefore no user data. One way to solve the problem of knowing who is connected to your web socket is by parsing and decoding the cookie that contains the passport session then deserializing it to obtain the user object. Luckily, there is a package on NPM just for this that turns a once complex task into something simple!</p>\n<p><code>passport.socketio@~3.7.0</code>, <code>connect-mongo@~3.2.0</code>, and <code>cookie-parser@~1.4.5</code> have already been added as dependencies. Require them as <code>passportSocketIo</code>, <code>MongoStore</code>, and <code>cookieParser</code> respectively. Also, we need to initialize a new memory store, from <code>express-session</code> which we previously required. It should look like this:</p>\n<pre><code class=\"language-js\">const MongoStore = require('connect-mongo')(session);\nconst URI = process.env.MONGO_URI;\nconst store = new MongoStore({ url: URI });\n</code></pre>\n<p>Now we just have to tell Socket.IO to use it and set the options. Be sure this is added before the existing socket code and not in the existing connection listener. For your server, it should look like this:</p>\n<pre><code class=\"language-js\">io.use(\n  passportSocketIo.authorize({\n    cookieParser: cookieParser,\n    key: 'express.sid',\n    secret: process.env.SESSION_SECRET,\n    store: store,\n    success: onAuthorizeSuccess,\n    fail: onAuthorizeFail\n  })\n);\n</code></pre>\n<p>Note that configuring Passport authentication for Socket.IO is very similar to the way we configured the <code>session</code> middleware for the API. This is because they are meant to use the same authentication method â€” get the session id from a cookie and validate it.</p>\n<p>Previously, when we configured the <code>session</code> middleware, we didn't explicitly set the cookie name for session (<code>key</code>). This is because the <code>session</code> package was using the default value. Now that we've added another package which needs access to the same value from the cookies, we need to explicitly set the <code>key</code> value in both configuration objects.</p>\n<p>Be sure to add the <code>key</code> with the cookie name to the <code>session</code> middleware that matches the Socket.IO key. Also, add the <code>store</code> reference to the options, near where we set <code>saveUninitialized: true</code>. This is necessary to tell Socket.IO which session to relate to.</p>\n<hr>\n<p>Now, define the <code>success</code>, and <code>fail</code> callback functions:</p>\n<pre><code class=\"language-js\">function onAuthorizeSuccess(data, accept) {\n  console.log('successful connection to socket.io');\n\n  accept(null, true);\n}\n\nfunction onAuthorizeFail(data, message, error, accept) {\n  if (error) throw new Error(message);\n  console.log('failed connection to socket.io:', message);\n  accept(null, false);\n}\n</code></pre>\n<p>The user object is now accessible on your socket object as <code>socket.request.user</code>. For example, now you can add the following:</p>\n<pre><code class=\"language-js\">console.log('user ' + socket.request.user.username + ' connected');\n</code></pre>\n<p>It will log to the server console who has connected!</p>\n<p>Submit your page when you think you've got it right. If you're running into errors, you can  <a href=\"https://forum.freecodecamp.org/t/advanced-node-and-express/567135#authentication-with-socketio-9\" target=\"_blank\" rel=\"noopener noreferrer nofollow\">check out the project up to this point</a>.</p>\n</section>",
  "translationPending": false,
  "block": "advanced-node-and-express",
  "hasEditableBoundaries": false,
  "order": 1,
  "superOrder": 6,
  "certification": "quality-assurance",
  "superBlock": "quality-assurance",
  "challengeOrder": 19,
  "required": [],
  "helpCategory": "JavaScript",
  "usesMultifileEditor": false,
  "disableLoopProtectTests": false,
  "disableLoopProtectPreview": false
}